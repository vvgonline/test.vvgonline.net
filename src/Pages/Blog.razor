@page "/Blog"
@using VVG.Web.Models
@inject HttpClient Http
@inject NavigationManager Navigation

<PageTitle>Blog - VVG ONLINE</PageTitle>

<HeroBanner Title="Digital Insights"
    Subtitle="A curated collection of articles, analyses, and perspectives on technology, strategy, and the future of business."
    TagUser="// DIGITAL_INSIGHTS" TagPath="// STAY_UPDATED" />

<section class="container py-5">
    <!-- Featured Posts Section -->
    @if (featuredPosts != null && featuredPosts.Length > 0)
    {
        <section class="container py-5">
            <div class="d-flex justify-content-between align-items-center mb-4">
                @if (@featuredPosts.Length == 1)
                {
                <h2 class="h3 text-warning mono">⭐ // @featuredPosts.Length FEATURED POST</h2>
                }
                else
                {
                <h2 class="h3 text-warning mono">⭐ // @featuredPosts.Length FEATURED POSTS</h2>
                }
            </div>

            <div class="row g-4 mb-5">
                @foreach (var post in featuredPosts)
                {
                    <div class="col-md-6 col-lg-4">
                        <div class="card h-100 p-4">
                            <div class="mb-3"><span class="insight-tag">@post.Category</span></div>
                            <h4 class="serif mb-3"><a href="/blog/@post.Slug" class="">@post.Title</a></h4>
                            <p class="small opacity-75 mb-4">@post.Excerpt</p>
                            <div class="mt-auto mono border-top pt-3 d-flex justify-content-between">
                                <span>@post.TimeToRead min read</span>
                                <a href="/blog/@post.Slug" class="">READ -></a>
                            </div>
                        </div>
                    </div>
                }
            </div>
            <hr class="border-secondary" />
        </section>
    }

    <!-- Search and Filters -->
    <div class="row mb-4 g-3">
        <div class="col-md-4">
            <div class="input-group">
                <span class="input-group-text bg-dark text-white border-secondary">
                    <i class="bi bi-search"></i>
                </span>
                <input type="text" class="form-control bg-dark text-white border-secondary"
                    placeholder="Search by title or excerpt..." @bind="searchTerm" @bind:event="oninput"
                    @onkeyup="HandleSearchKeyup" />
                @if (!string.IsNullOrWhiteSpace(searchTerm))
                {
                    <button class="btn btn-outline-secondary" type="button" @onclick="ClearSearch">
                        <i class="bi bi-x-circle"></i>
                    </button>
                }
            </div>
        </div>

        <div class="col-md-3">
            <select class="form-select bg-dark text-white border-secondary" @bind="selectedTag"
                @bind:after="ApplyFilters">
                <option value="All">All Tags (@(availableTags?.Length ?? 0))</option>
                <option value="Must">Must (@GetTagCount("Must"))</option>
                <option value="Recommended">Recommended (@GetTagCount("Recommended"))</option>
                <option value="Top">Top (@GetTagCount("Top"))</option>
                <option disabled>──────────</option>
                @if (availableTags != null)
                {
                    @foreach (var tag in availableTags.Where(t => t != "Must" && t != "Recommended" && t != "Top"))
                    {
                        <option value="@tag">#@tag (@GetTagCount(tag))</option>
                    }
                }
            </select>
        </div>


        <div class="col-md-2">
            <select class="form-select bg-dark text-white border-secondary" @bind="selectedYear"
                @bind:after="ApplyFilters">
                <option value="All">All Years</option>
                @if (availableYears != null)
                {
                    @foreach (var year in availableYears)
                    {
                        <option value="@year">@year</option>
                    }
                }
            </select>
        </div>

        <div class="col-md-3">
            <select class="form-select bg-dark text-white border-secondary" @bind="currentSortOrder"
                @bind:after="ApplyFilters">
                <option value="date_desc">Newest First</option>
                <option value="date_asc">Oldest First</option>
                <option value="title_asc">Title (A-Z)</option>
                <option value="title_desc">Title (Z-A)</option>
                <option value="reading_time_asc">Quick Read First</option>
                <option value="reading_time_desc">Long Read First</option>
            </select>
        </div>
    </div>

    @if (isLoading)
    {
        <div class="text-center py-5">
            <div class="spinner-border text-warning" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-3 opacity-75 mono">LOADING INSIGHTS...</p>
        </div>
    }
    else if (!string.IsNullOrEmpty(errorMessage))
    {
        <div class="alert alert-danger">
            <strong>Error loading blog posts:</strong> @errorMessage
        </div>
    }
    else if (paginatedPosts == null || paginatedPosts.Length == 0)
    {
        <div class="text-center py-5">
            <i class="bi bi-inbox display-1 opacity-75"></i>
            <h3 class="mt-4">No posts found</h3>
            <p class="opacity-75">Try adjusting your filters or search query.</p>
            @if (selectedTag != "All" || selectedYear != "All" || !string.IsNullOrWhiteSpace(searchTerm))
            {
                <button class="btn btn-outline-warning mt-3" @onclick="ClearAllFilters">
                    Clear All Filters
                </button>
            }
        </div>
    }
    else
    {
        <!-- Blog Posts Grid - Dark Cards Style -->
        <!-- Blog Posts Grid - Use same style as Home.razor -->
        <div class="row g-4 mb-5">
            @foreach (var post in paginatedPosts)
            {
                <div class="col-md-6 col-lg-4">
                    <div class="card h-100 p-4">
                        <div class="mb-3"><span class="insight-tag">@post.Category</span></div>
                        <h4 class="serif mb-3"><a href="/blog/@post.Slug" class="">@post.Title</a></h4>
                        <p class="small opacity-75 mb-4">@post.Excerpt</p>
                        <div class="mt-auto mono border-top pt-3 d-flex justify-content-between">
                            <span>@post.TimeToRead min read</span>
                            <a href="/blog/@post.Slug" class="">READ -></a>
                        </div>
                    </div>
                </div>
            }
        </div>

        <!-- Pagination -->
        @if (totalPages > 1)
        {
            <nav aria-label="Blog pagination">
                <ul class="pagination justify-content-center">
                    <li class="page-item @(currentPage == 1 ? "disabled" : "")">
                        <button class="page-link bg-dark text-white border-secondary" @onclick="() => GoToPage(currentPage - 1)"
                            disabled="@(currentPage == 1)">
                            <i class="bi bi-chevron-left"></i> Previous
                        </button>
                    </li>

                    @for (int i = 1; i <= totalPages; i++)
                    {
                        var pageNum = i;
                        <li class="page-item @(currentPage == pageNum ? "active" : "")">
                            <button
                                class="page-link @(currentPage == pageNum ? "bg-warning " : "bg-dark text-white") border-secondary"
                                @onclick="() => GoToPage(pageNum)">
                                @pageNum
                            </button>
                        </li>
                    }

                    <li class="page-item @(currentPage == totalPages ? "disabled" : "")">
                        <button class="page-link bg-dark text-white border-secondary" @onclick="() => GoToPage(currentPage + 1)"
                            disabled="@(currentPage == totalPages)">
                            Next <i class="bi bi-chevron-right"></i>
                        </button>
                    </li>
                </ul>
            </nav>
        }
    }

    <!-- Call to Action Section - ADD THIS -->
    <div class="container my-5 py-5">
        <div class="row">
            <div class="col-12">
                <div class="card bg-gradient border-warning p-5 text-center">
                    <div class="card-body">
                        <h2 class="mono text-warning mb-3">// READY_TO_TRANSFORM</h2>
                        <h3 class="h2 mb-4">Let's Build Something Extraordinary</h3>
                        <p class="lead opacity-75 mb-4">
                            Transform your business with cutting-edge digital solutions.
                            Our team specializes in digital transformation, custom software development,
                            and strategic consulting.
                        </p>
                        <div class="d-flex justify-content-center gap-3 flex-wrap">
                            <a href="/contact" class="btn btn-warning btn-lg px-5 py-3">
                                <i class="bi bi-envelope-fill me-2"></i>
                                CONTACT VVG ONLINE
                            </a>
                            <a href="/BlogArchives" class="btn btn-outline-warning btn-lg px-5 py-3">
                                <i class="bi bi-archive-fill me-2"></i>
                                EXPLORE ARCHIVES
                            </a>
                        </div>
                        <div class="mt-4">
                            <p class="small opacity-75 mono">
                                // JOIN_THE_DIGITAL_REVOLUTION
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

@code {
    private Models.BlogPost[]? allPosts;
    private Models.BlogPost[]? filteredPosts;
    private Models.BlogPost[]? paginatedPosts;
    private Models.BlogPost[]? featuredPosts;

    private string[]? availableTags;
    private string[]? availableYears;

    private string searchTerm = "";
    private string selectedTag = "All";
    private string selectedYear = "All";
    private string currentSortOrder = "date_desc";

    private int currentPage = 1;
    private int pageSize = 9;
    private int totalPages = 0;

    private bool isLoading = true;
    private string? errorMessage = null;

    private System.Timers.Timer? debounceTimer;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            Console.WriteLine("Blog: Starting to load posts...");

            allPosts = await Http.GetFromJsonAsync<Models.BlogPost[]>("data/blog-index.json");

            Console.WriteLine($"Blog: Loaded {allPosts?.Length ?? 0} posts");

            if (allPosts != null && allPosts.Length > 0)
            {
                // Filter out drafts
                allPosts = allPosts.Where(p => !p.Draft).ToArray();
                Console.WriteLine($"Blog: After filtering drafts: {allPosts.Length} posts");

                // Get featured posts - ADD THIS
                featuredPosts = allPosts
                .Where(p => p.Featured)
                .OrderByDescending(p => p.PublishedAt)
                .Take(3)
                .ToArray();
                Console.WriteLine($"Blog: Found {featuredPosts.Length} featured posts");

                ExtractFilters();
                PerformFiltering();
            }
        }
        catch (Exception ex)
        {
            errorMessage = ex.Message;
            Console.WriteLine($"Blog ERROR: {ex.Message}");
        }
        finally
        {
            isLoading = false;
        }
    }

    private void ExtractFilters()
    {
        if (allPosts == null) return;

        // Extract unique tags
        var allTags = allPosts
        .Where(p => p.Tags != null)
        .SelectMany(p => p.Tags!)
        .Distinct()
        .OrderBy(t => t)
        .ToList();

        availableTags = allTags.ToArray();

        // Extract unique years
        var allYears = allPosts
        .Select(p => p.PublishedAt.Year)
        .Distinct()
        .OrderByDescending(y => y)
        .Select(y => y.ToString())
        .ToList();

        availableYears = allYears.ToArray();
    }

    private void PerformFiltering()
    {
        if (allPosts is null) return;

        var query = allPosts.AsEnumerable();

        // Search filter
        if (!string.IsNullOrWhiteSpace(searchTerm))
        {
            var searchLower = searchTerm.ToLower();
            query = query.Where(p =>
            (!string.IsNullOrEmpty(p.Title) && p.Title.Contains(searchLower, StringComparison.OrdinalIgnoreCase)) ||
            (!string.IsNullOrEmpty(p.Excerpt) && p.Excerpt.Contains(searchLower, StringComparison.OrdinalIgnoreCase)) ||
            (p.Category.HasValue && p.Category.Value.ToString().Contains(searchLower, StringComparison.OrdinalIgnoreCase))
            );
        }

        // Tag filter
        if (selectedTag != "All")
        {
            query = query.Where(p => p.Tags?.Contains(selectedTag) ?? false);
        }

        // Year filter
        if (selectedYear != "All" && int.TryParse(selectedYear, out int year))
        {
            query = query.Where(p => p.PublishedAt.Year == year);
        }

        // Sorting
        query = currentSortOrder switch
        {
            "date_asc" => query.OrderBy(p => p.PublishedAt),
            "title_asc" => query.OrderBy(p => p.Title),
            "title_desc" => query.OrderByDescending(p => p.Title),
            "reading_time_asc" => query.OrderBy(p => p.TimeToRead),
            "reading_time_desc" => query.OrderByDescending(p => p.TimeToRead),
            _ => query.OrderByDescending(p => p.PublishedAt),
        };

        filteredPosts = query.ToArray();
        totalPages = (int)Math.Ceiling((filteredPosts?.Length ?? 0) / (double)pageSize);

        // Ensure currentPage is valid
        if (currentPage > totalPages && totalPages > 0)
        {
            currentPage = totalPages;
        }
        else if (totalPages == 0)
        {
            currentPage = 1;
        }

        paginatedPosts = filteredPosts?.Skip((currentPage - 1) * pageSize).Take(pageSize).ToArray();
    }

    private void ApplyFilters()
    {
        currentPage = 1;
        PerformFiltering();
    }

    private void HandleSearchKeyup()
    {
        debounceTimer?.Stop();
        debounceTimer = new System.Timers.Timer(300);
        debounceTimer.Elapsed += (s, e) =>
        {
            debounceTimer.Stop();
            InvokeAsync(() =>
    {
            ApplyFilters();
            StateHasChanged();
        });
        };
        debounceTimer.Start();
    }

    private void ClearSearch()
    {
        searchTerm = "";
        ApplyFilters();
    }

    private void ClearAllFilters()
    {
        searchTerm = "";
        selectedTag = "All";
        selectedYear = "All";
        currentSortOrder = "date_desc";
        ApplyFilters();
    }

    private void GoToPage(int page)
    {
        if (page < 1 || page > totalPages) return;
        currentPage = page;
        PerformFiltering();
    }

    public void Dispose()
    {
        debounceTimer?.Dispose();
    }

    private int GetTagCount(string tag)
    {
        if (allPosts == null) return 0;
        return allPosts.Count(p => p.Tags?.Contains(tag) ?? false);
    }
}