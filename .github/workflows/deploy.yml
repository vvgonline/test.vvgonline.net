name: Deploy VVG System to GitHub Pages

on:
  push:
    branches:
      - main

permissions:
  contents: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup .NET SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.101'

      - name: Clean Build Artifacts
        run: dotnet clean src/VVG.Web.csproj -c Release

      - name: Publish Project
        run: dotnet publish src/VVG.Web.csproj -c Release -o release /p:StaticWebAssetBasePath=/ --nologo

      - name: Generate Blog Index
        run: |
          cat > generate-blog-index.js << 'EOF'
          const fs = require('fs');
          const path = require('path');
          
          const blogDir = 'src/wwwroot/assets/data/blogs';
          const outputFile = 'src/wwwroot/data/blog-index.json';
          
          const posts = [];
          
          // Create output directory if it doesn't exist
          fs.mkdirSync(path.dirname(outputFile), { recursive: true });
          
          if (fs.existsSync(blogDir)) {
            fs.readdirSync(blogDir).forEach(file => {
              if (file.endsWith('.md')) {
                const content = fs.readFileSync(path.join(blogDir, file), 'utf8');
                const frontMatterMatch = content.match(/^---\n([\s\S]*?)\n---/);
                
                if (frontMatterMatch) {
                  const frontMatter = frontMatterMatch[1];
                  const post = {};
                  
                  frontMatter.split('\n').forEach(line => {
                    const match = line.match(/^(\w+):\s*(.+)$/);
                    if (match) {
                      const [, key, value] = match;
                      
                      // Handle arrays like ["tag1", "tag2"] or [tag1, tag2]
                      if (value.trim().startsWith('[')) {
                        try {
                          post[key] = JSON.parse(value.replace(/'/g, '"'));
                        } catch {
                          post[key] = [];
                        }
                      }
                      // Handle booleans
                      else if (value.trim() === 'true' || value.trim() === 'false') {
                        post[key] = value.trim() === 'true';
                      }
                      // Handle numbers
                      else if (!isNaN(value.trim())) {
                        post[key] = parseInt(value.trim());
                      }
                      // Handle strings
                      else {
                        post[key] = value.replace(/^["']|["']$/g, '').trim();
                      }
                    }
                  });
                  
                  posts.push(post);
                }
              }
            });
          }
          
          fs.writeFileSync(outputFile, JSON.stringify(posts, null, 2));
          console.log(`âœ… Generated blog index with ${posts.length} posts`);
          console.log(JSON.stringify(posts, null, 2));
          EOF
          
          node generate-blog-index.js

      - name: Copy Blog Index to Release
        run: |
          mkdir -p release/wwwroot/data
          cp src/wwwroot/data/blog-index.json release/wwwroot/data/

      - name: Prepare GitHub Pages Artifacts
        run: |
          # Ensure folders starting with '_' are served
          touch release/wwwroot/.nojekyll
          # Copy index for SPA routing fallback
          cp release/wwwroot/index.html release/wwwroot/404.html
          # Copy CNAME if it exists (for custom domain)
          if [ -f "CNAME" ]; then
            cp CNAME release/wwwroot/CNAME
          fi

      - name: Deploy to GitHub Pages
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          folder: release/wwwroot
          branch: gh-pages
