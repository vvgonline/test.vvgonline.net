@page "/blog"
@using System.Net.Http.Json
@using VVG.Web.Models
@using System.Web
@inject HttpClient Http
@inject VVG.Web.Services.MetadataService MetadataService
@inject NavigationManager NavigationManager

<HeroBanner Title="Digital Insights"
    Subtitle="A curated collection of articles, analyses, and perspectives on technology, strategy, and the future of business."
    TagUser="// DIGITAL_INSIGHTS" TagPath="// STAY_UPDATED" />

<section class="container py-5">
    <!-- Featured Posts -->
    @if (featuredPosts is not null && featuredPosts.Any())
    {
        <div class="mb-5">
            <h2 class="display-5">Featured Insights</h2>
            <div class="row g-4 mt-3">
                @foreach (var post in featuredPosts)
                {
                    <div class="col-lg-4">
                        <div class="card h-100 p-4">
                            <div class="mb-3"><span class="insight-tag">@post.Category</span></div>
                            <h4 class="serif mb-3"><a href="/blog/@post.Slug" class="text-dark">@post.Title</a></h4>
                            <p class="small opacity-75 mb-4">@post.Excerpt</p>
                            <div class="mt-auto mono border-top pt-3 d-flex justify-content-between">
                                <span>@post.PublishedAt.ToString("MMM dd, yyyy")</span>
                                <span>@post.TimeToRead min read</span>
                            </div>
                        </div>
                    </div>
                }
            </div>
        </div>
    }

    <!-- Filters and Sorting -->
    <div class="row mb-4 g-2">
        <div class="col-md-4">
            <input type="text" class="form-control @(!string.IsNullOrWhiteSpace(searchTerm) ? "active-filter" : "")"
                placeholder="Search by title or excerpt..." @bind-value="searchTerm" @oninput="ApplyFilters" />
        </div>
        <div class="col-md-2">
            <select class="form-select @(selectedTag != "All" ? "active-filter" : "")" @bind="selectedTag">
                <option value="All">All Tags</option>
                <option value="Must">Must @(tagsSummary != null && tagsSummary.ContainsKey("Must") ?
                                        $"({tagsSummary["Must"]})" : "")</option>
                <option value="Recommended">Recommended @(tagsSummary != null && tagsSummary.ContainsKey("Recommended")
                                        ? $"({tagsSummary["Recommended"]})" : "")</option>
                <option value="Top">Top @(tagsSummary != null && tagsSummary.ContainsKey("Top") ?
                                        $"({tagsSummary["Top"]})" : "")</option>
                @if (tagsSummary is not null)
                {
                    @foreach (var tag in tagsSummary.Keys)
                    {
                        @if (tag != "Must" && tag != "Recommended" && tag != "Top")
                        {
                            <option value="@tag">#@tag (@tagsSummary[tag])</option>
                        }
                    }
                }
            </select>
        </div>
        <div class="col-md-2">
            <select class="form-select @(selectedYear != "All" ? "active-filter" : "")" @bind="selectedYear">
                <option value="All">All Years</option>
                @if (yearsSummary is not null)
                {
                    @foreach (var year in yearsSummary.Keys)
                    {
                        <option value="@year">@year (@yearsSummary[year])</option>
                    }
                }
            </select>
        </div>
        <div class="col-md-4">
            <select class="form-select @(currentSortOrder != "date_desc" ? "active-filter" : "")"
                @bind="currentSortOrder">
                <option value="date_desc">Sort by Date (Newest First)</option>
                <option value="date_asc">Sort by Date (Oldest First)</option>
                <option value="title_asc">Sort by Title (A-Z)</option>
                <option value="title_desc">Sort by Title (Z-A)</option>
                <option value="reading_time">Sort by Reading Time</option>
            </select>
        </div>
    </div>

    <!-- Blog Post Listings -->
    @if (paginatedPosts is null)
    {
        <div class="text-center py-5">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    }
    else if (!paginatedPosts.Any())
    {
        <div class="text-center py-5">
            <p>No posts found matching your criteria. Try adjusting your filters.</p>
        </div>
    }
    else
    {
        <div class="row g-4">
            @foreach (var post in paginatedPosts)
            {
                <div class="col-md-6 col-lg-4">
                    <div class="card h-100 p-4">
                        <div class="mb-3"><span class="insight-tag">@post.Category</span></div>
                        <h4 class="serif mb-3"><a href="/blog/@post.Slug" class="text-dark">@post.Title</a></h4>
                        <p class="small opacity-75 mb-4">@post.Excerpt</p>
                        <div class="d-flex flex-wrap-reverse">
                            @if (post.Tags is not null)
                            {
                                @foreach (var tag in post.Tags)
                                {
                                    var tagCount = tagsSummary != null && tagsSummary.ContainsKey(tag) ? tagsSummary[tag] : 0;
                                    <a href="#" @onclick='() => FilterByTag(tag)' @onclick:preventDefault
                                        class="badge bg-light text-dark me-1 mb-1">#@tag (@tagCount)</a>
                                }
                            }
                        </div>
                        <div class="mt-auto mono border-top pt-3 d-flex justify-content-between">
                            <span>@post.PublishedAt.ToString("MMM dd, yyyy")</span>
                            <span>@post.TimeToRead min read</span>
                        </div>
                    </div>
                </div>
            }
        </div>

        <!-- Pagination -->
        <nav class="mt-5">
            <ul class="pagination justify-content-center">
                @for (int i = 1; i <= totalPages; i++)
                {
                    var pageNumber = i;
                    <li class="page-item @(currentPage == pageNumber ? "active" : "")">
                        <a class="page-link" href="#" @onclick="() => GoToPage(pageNumber)"
                            @onclick:preventDefault>@pageNumber</a>
                    </li>
                }
            </ul>
        </nav>
    }

    <!-- CTA -->
    <div class="text-center pt-5 mt-5 border-top">
        <h3 class="fw-light">Ready to transform your business?</h3>
        <p class="lead text-muted">Let's discuss how VVG ONLINE can help you achieve your goals.</p>
        <a href="/contact" class="btn btn-vvg mt-3 no-cursor">Get in Touch</a>
    </div>
    @* share-buttons *@
    <div class="d-flex justify-content-center gap-3 mt-4">
        <a href="https://twitter.com/intent/tweet?url=@CurrentPageUrl" target="_blank" class="btn btn-outline-dark"><i
                class="bi bi-twitter"></i> Share on Twitter</a>
        <a href="https://www.facebook.com/sharer/sharer.php?u=@CurrentPageUrl" target="_blank"
            class="btn btn-outline-dark"><i class="bi bi-facebook"></i> Share on Facebook</a>
        <a href="https://www.linkedin.com/shareArticle?mini=true&url=@CurrentPageUrl" target="_blank"
            class="btn btn-outline-dark"><i class="bi bi-linkedin"></i>&nbsp; Share on LinkedIn</a>
    </div>
</section>

@code {
    private VVG.Web.Models.BlogPost[]? allPosts;
    private VVG.Web.Models.BlogPost[]? filteredPosts;
    private VVG.Web.Models.BlogPost[]? paginatedPosts;
    private VVG.Web.Models.BlogPost[]? featuredPosts;

    private string searchTerm = string.Empty;
    private string selectedTag = "All";
    private string selectedYear = "All";
    private string currentSortOrder = "date_desc";

    private Dictionary<string, int>? tagsSummary;
    private Dictionary<string, int>? yearsSummary;

    private int currentPage = 1;
    private int pageSize = 9;
    private int totalPages;
    private string CurrentPageUrl => NavigationManager.ToAbsoluteUri(NavigationManager.Uri).ToString();

    protected override async Task OnInitializedAsync()
    {
        var defaultMetadata = await MetadataService.GetMetadataAsync();
        var defaultTwitterCard = await MetadataService.GetTwitterCardAsync();
        var defaultOpenGraph = await MetadataService.GetOpenGraphAsync();
        var defaultJsonLd = await MetadataService.GetJsonLdAsync();

        MetadataService.SetPageMetadata(new PageMetadata
        {
            Title = "Blog - VVG ONLINE",
            Description = "Insights, articles, and analysis from VVG ONLINE on digital transformation, strategy, and technology.",
            Keywords = "blog, insights, articles, digital transformation, technology, business strategy",
            Image = defaultOpenGraph?.Image, // Use default OpenGraph image as fallback

            OgType = defaultOpenGraph?.Type ?? "website",
            OgTitle = "Blog - VVG ONLINE",
            OgDescription = "Explore insights on digital transformation and business strategy.",
            OgImage = defaultOpenGraph?.Image,
            OgUrl = defaultOpenGraph?.Url,

            TwitterCard = defaultTwitterCard?.Card ?? "summary_large_image",
            TwitterSite = defaultTwitterCard?.Site ?? "@vvgonline",
            TwitterCreator = defaultTwitterCard?.Creator ?? "@vvgonline",
            TwitterTitle = "Blog - VVG ONLINE",
            TwitterDescription = "Explore insights on digital transformation and business strategy.",
            TwitterImage = defaultTwitterCard?.Image,
            JsonLd = defaultJsonLd
        });

        var blogIndex = await Http.GetFromJsonAsync<VVG.Web.Models.BlogIndex>("data/blog-index.json");
        if (blogIndex is not null)
        {
            allPosts = blogIndex.Posts?.Where(p => !p.Draft).ToArray();
            tagsSummary = blogIndex.TagsSummary;
            yearsSummary = blogIndex.YearsSummary;

            featuredPosts = allPosts?.Where(p => p.Featured).OrderByDescending(p => p.PublishedAt).Take(3).ToArray();

            var uri = NavigationManager.ToAbsoluteUri(NavigationManager.Uri);
            var queryParams = HttpUtility.ParseQueryString(uri.Query);

            searchTerm = queryParams["search"] ?? string.Empty;
            selectedTag = queryParams["tag"] ?? "All";
            selectedYear = queryParams["year"] ?? "All";
            currentSortOrder = queryParams["sort"] ?? "date_desc";
            if (int.TryParse(queryParams["page"], out int page))
            {
                currentPage = page;
            }

            PerformFiltering();
        }
    }

    private void PerformFiltering()
    {
        if (allPosts is null) return;

        var query = allPosts.AsEnumerable();

        // Search filter
        if (!string.IsNullOrWhiteSpace(searchTerm))
        {
            query = query.Where(p => (p.Title?.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ?? false) ||
            (p.Excerpt?.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ?? false));
        }

        // Tag filter
        if (selectedTag != "All")
        {
            query = query.Where(p => p.Tags?.Contains(selectedTag) ?? false);
        }

        // Year filter
        if (selectedYear != "All" && int.TryParse(selectedYear, out int year))
        {
            query = query.Where(p => p.PublishedAt.Year == year);
        }

        // Sorting
        query = currentSortOrder switch
        {
            "date_asc" => query.OrderBy(p => p.PublishedAt),
            "title_asc" => query.OrderBy(p => p.Title),
            "title_desc" => query.OrderByDescending(p => p.Title),
            "reading_time" => query.OrderBy(p => p.TimeToRead),
            _ => query.OrderByDescending(p => p.PublishedAt),
        };

        filteredPosts = query.ToArray();
        totalPages = (int)Math.Ceiling(filteredPosts.Length / (double)pageSize);

        // Ensure currentPage is valid after filtering, otherwise reset to 1
        if (currentPage > totalPages && totalPages > 0)
        {
            currentPage = totalPages;
        }
        else if (totalPages == 0)
        {
            currentPage = 1;
        }

        paginatedPosts = filteredPosts?.Skip((currentPage - 1) * pageSize).Take(pageSize).ToArray();
    }

    private void UpdateUrl()
    {
        var queryParams = new Dictionary<string, string>();
        if (!string.IsNullOrWhiteSpace(searchTerm)) queryParams["search"] = searchTerm;
        if (selectedTag != "All") queryParams["tag"] = selectedTag;
        if (selectedYear != "All") queryParams["year"] = selectedYear;
        if (currentSortOrder != "date_desc") queryParams["sort"] = currentSortOrder;
        if (currentPage > 1) queryParams["page"] = currentPage.ToString();

        var uriBuilder = new UriBuilder(NavigationManager.ToAbsoluteUri(NavigationManager.Uri))
        {
            Query = string.Join("&", queryParams.Select(kvp => $"{kvp.Key}={kvp.Value}"))
        };

        NavigationManager.NavigateTo(uriBuilder.Uri.ToString());
    }

    private void ApplyFilters()
    {
        currentPage = 1; // Reset to first page when filters change
        UpdateUrl();
    }

    private void GoToPage(int pageNumber)
    {
        currentPage = pageNumber;
        UpdateUrl();
    }

    private void FilterByTag(string tag)
    {
        selectedTag = tag;
        ApplyFilters();
    }

}