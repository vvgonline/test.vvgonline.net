name: Deploy VVG System to GitHub Pages

on:
  push:
    branches:
      - main

permissions:
  contents: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup .NET SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.101'

      - name: Clean Build Artifacts
        run: dotnet clean src/VVG.Web.csproj -c Release

      - name: Publish Project
        run: dotnet publish src/VVG.Web.csproj -c Release -o release /p:StaticWebAssetBasePath=/ --nologo

      - name: Generate Blog Index
        run: |
          cat > generate-blog-index.js << 'EOF'
          const fs = require('fs');
          const path = require('path');
          
          const blogDir = 'src/wwwroot/assets/data/blogs';
          const outputFile = 'src/wwwroot/data/blog-index.json';
          
          const posts = [];
          
          // Create output directory if it doesn't exist
          fs.mkdirSync(path.dirname(outputFile), { recursive: true });
          
          if (fs.existsSync(blogDir)) {
            fs.readdirSync(blogDir).forEach(file => {
              if (file.endsWith('.md')) {
                const content = fs.readFileSync(path.join(blogDir, file), 'utf8');
                const frontMatterMatch = content.match(/^---\n([\s\S]*?)\n---/);
                
                if (frontMatterMatch) {
                  const frontMatter = frontMatterMatch[1];
                  const post = {};
                  
                  frontMatter.split('\n').forEach(line => {
                    const match = line.match(/^(\w+):\s*(.+)$/);
                    if (match) {
                      const [, key, value] = match;
                      
                      // Handle arrays like ["tag1", "tag2"] or [tag1, tag2]
                      if (value.trim().startsWith('[')) {
                        try {
                          post[key] = JSON.parse(value.replace(/'/g, '"'));
                        } catch {
                          post[key] = [];
                        }
                      }
                      // Handle booleans
                      else if (value.trim() === 'true' || value.trim() === 'false') {
                        post[key] = value.trim() === 'true';
                      }
                      // Handle numbers
                      else if (!isNaN(value.trim())) {
                        post[key] = parseInt(value.trim());
                      }
                      // Handle strings
                      else {
                        post[key] = value.replace(/^["']|["']$/g, '').trim();
                      }
                    }
                  });
                  
                  // Add filename property (without .md extension)
                  post.filename = file.replace('.md', '');
                  
                  posts.push(post);
                }
              }
            });
          }
          
          fs.writeFileSync(outputFile, JSON.stringify(posts, null, 2));
          console.log(`‚úÖ Generated blog index with ${posts.length} posts`);
          console.log(JSON.stringify(posts, null, 2));
          EOF
          
          node generate-blog-index.js

      - name: Copy Blog Index to Release
        run: |
          mkdir -p release/wwwroot/data
          cp src/wwwroot/data/blog-index.json release/wwwroot/data/

      - name: Copy Markdown Files to Release
        run: |
          echo "üìù Copying markdown blog files..."
          mkdir -p release/wwwroot/assets/data/blogs
          
          if [ -d "src/wwwroot/assets/data/blogs" ]; then
            cp -v src/wwwroot/assets/data/blogs/*.md release/wwwroot/assets/data/blogs/
            echo "‚úÖ Markdown files copied successfully"
            echo "Files in release:"
            ls -la release/wwwroot/assets/data/blogs/
          else
            echo "‚ùå Source directory not found: src/wwwroot/assets/data/blogs"
            exit 1
          fi

      - name: Verify Deployment Files
        run: |
          echo "=== üìÅ Checking deployment structure ==="
          echo ""
          echo "Root files:"
          ls -la release/wwwroot/ | head -20
          echo ""
          echo "Data folder:"
          ls -la release/wwwroot/data/ || echo "‚ùå data folder not found"
          echo ""
          echo "Blog markdown files:"
          ls -la release/wwwroot/assets/data/blogs/ || echo "‚ùå blogs folder not found"
          echo ""
          echo "File count:"
          echo "  - MD files: $(find release/wwwroot/assets/data/blogs/ -name '*.md' 2>/dev/null | wc -l)"
          echo "  - JSON files: $(find release/wwwroot/data/ -name '*.json' 2>/dev/null | wc -l)"

      - name: Prepare GitHub Pages Artifacts
        run: |
          # Ensure folders starting with '_' are served
          touch release/wwwroot/.nojekyll
          
          # Copy custom 404.html for SPA routing
          if [ -f "release/wwwroot/404.html" ]; then
            echo "‚úÖ 404.html already exists"
          else
            echo "‚ö†Ô∏è Creating 404.html from index.html"
            cp release/wwwroot/index.html release/wwwroot/404.html
          fi
          
          # Copy CNAME if it exists (for custom domain)
          if [ -f "CNAME" ]; then
            cp CNAME release/wwwroot/CNAME
            echo "‚úÖ CNAME copied"
          fi

      - name: Deploy to GitHub Pages
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          folder: release/wwwroot
          branch: gh-pages
          clean: true
